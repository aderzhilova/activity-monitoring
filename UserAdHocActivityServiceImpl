@Internal
public class UserAdHocActivityServiceImpl implements UserAdHocActivityService, ApplicationContextAware  {

	protected final static String BAM_DISPATCHER_BEAN = "bamDispatcher";
	
	private final static String ON_HOLD = "On Hold";
	private final static String HOLD_PENDING = "Hold Pending";
	private final static String ACTIVE = "Active";

	private ApplicationContext applicationContext;
	private CurrentUserService currentUserService;
	private UserHoldService UserHoldService;
	
	public void setApplicationContext(ApplicationContext applicationContext) {
		this.applicationContext = applicationContext;
	}

	public void setCurrentUserService(CurrentUserService currentUserService) {
		this.currentUserService = currentUserService;
	}
	
	public void setUserHoldService(UserHoldService UserHoldService) {
		this.UserHoldService = UserHoldService;
	}

	public void registerActivity(UserAccount UserAccount, BigDecimal amount, String activityName, String messageId, String policyNumber, String comment, Date installmentDueDate, Date HoldEffectiveDate, UserAccountStatus UserAccountStatus){
		
		UserAccountActivity activity = new UserAccountActivity();

		activity.setName(activityName);
		if(null != messageId){
			activity.setMessageId(messageId);
		} else {
			//generate message id as name prefixed by "adhoc" and removed possible non-alpha symbols
		    String generatedId = "adhoc" + StringUtils.remove(StringUtils.deleteWhitespace(activityName), '-');
			activity.setMessageId(generatedId);
		}
		if(null != UserAccount){
			activity.setPrimaryEntityId(UserAccount.getAccountNumber());
			activity.setUserAccountNumber(UserAccount.getAccountNumber());
			activity.setCurrency(UserAccount.getUserInfo().getCurrency());
		    activity.setCustomerNumber(UserAccount.getUserInfo().getCustomerNumber());
		}
	    activity.setStartedTime(DateUtils.getCurrentTimestamp());
	    activity.setEndedTime(DateUtils.getCurrentTimestamp());
	    activity.setLastStatus(ActivityStatus.FINISHED);
	    activity.setPerformerId(currentUserService.getCurrentUser().getName());
	    activity.setInstallmentDueDate(installmentDueDate);
	    activity.setUserTransactionDate(HoldEffectiveDate);
	    if (UserAccountStatus != null) {
	    	activity.setUserAccountStatus(statusConverter(UserAccountStatus));
	    }
	    	    	    	    
	    EventDispatcher dispatcher = (EventDispatcher)applicationContext.getBean(BAM_DISPATCHER_BEAN);
		dispatcher.dispatch(new ActivityCreatedEvent(activity));
	}
	
	public void registerActivity(BillablePolicyTerm policyTerm, String accountNumber, String activityName, String messageId, String comment, Date HoldEffectiveDate){
		
		UserAccountActivity activity = new UserAccountActivity();

		activity.setName(activityName);
		if(null != messageId){
			activity.setMessageId(messageId);
		} else {
			//generate message id as name prefixed by "adhoc" and removed possible non-alpha symbols
		    String generatedId = "adhoc" + StringUtils.remove(StringUtils.deleteWhitespace(activityName), '-');
			activity.setMessageId(generatedId);
		}
		activity.setPrimaryEntityId(accountNumber);
		activity.setUserAccountNumber(accountNumber);
	    activity.setStartedTime(DateUtils.getCurrentTimestamp());
	    activity.setEndedTime(DateUtils.getCurrentTimestamp());
	    activity.setLastStatus(ActivityStatus.FINISHED);
	    activity.setPerformerId(currentUserService.getCurrentUser().getName());
	    activity.setUserTransactionDate(HoldEffectiveDate);
	    if (policyTerm != null) {
		    activity.setPolicyNumber(policyTerm.getPolicyNumber());
	    	activity.setPolicyBillableStatus(statusConverter(policyTerm));
	    }
	    activity.setCommentText(comment);
	    EventDispatcher dispatcher = (EventDispatcher)applicationContext.getBean(BAM_DISPATCHER_BEAN);
		dispatcher.dispatch(new ActivityCreatedEvent(activity));
	}
	
	public void registerActivity(UserAccount UserAccount, String activityName, String policyNumber, Date dueDate){
		registerActivity(UserAccount, null, activityName, null, policyNumber, null, dueDate, null, null);
	}
	
	    public void registerActivity(UserAccount UserAccount, String activityName, String policyNumber){
        registerActivity(UserAccount, null, activityName, null, policyNumber, null, null, null, null);
    }

	public void registerActivity(UserAccount UserAccount, String activityName, String messageId, String policyNumber, String comment){
		registerActivity(UserAccount, null, activityName, messageId, policyNumber, comment, null, null, null);
	}

	public void registerActivity(UserAccount UserAccount, String activityName){
		registerActivity(UserAccount, activityName, null, null, null);
	}
}
